# Overview

- Uses the TD API for autotrading
- Deploys a portfolio of models developed with [cltest](https://github.com/causality-loop/cltest)
- Relies upon OHLCV generated by [updateprices](https://github.com/causality-loop/updateprices)

# Materials

- This package
- [cltest](https://github.com/causality-loop/cltest)
- [clmodels](https://github.com/causality-loop/clmodels)
- [updateprices](https://github.com/causality-loop/updateprices)
- A VPS running GNU/Linux
- The *cronie* or *cron* package (name dependent upon GNU/Linux distro)

# Method

## Background

- Models are developed with the *cltest* package in conjunction with the *updateprices* package, then that portfolio of models is deployed with *cldeploy*
- See below for usage examples 
- End-users are encouraged to deviate from the following examples, as **the author of this package is not a reliable financial advisor**
 
## Setup

- Using *updateprices* to fetch OHLCV from Yahoo:
```r
kda_symbols <- c('SPY', 'FXI', 'EWJ', 'EEM', 'VNQ', 'RWX', 'DBC', 'GLD', 'VWO', 'AGG')
gan_symbols <- c('SPY', 'DIA', 'QQQ')
can_symbols <- c('SPY', 'VWO', 'AGG')
asset_info <- c(kda_symbols, gan_symbols, can_symbols)

updateprices::update_prices(
  asset_info, 
  market_open_check = FALSE,
  include_index_symbols = '',
  from_date = '1900-01-01')
```

## Testing and Quarterly Evaluation/Revision

- Developing a portfolio of models with *cltest* using the OHLCV data fetched by *updateprices*:
```r
model_info <- c(
  'CAN' = 1.5,
  'GAN' = 1,
  'KDA_no_treasuries' = 1.5)
  
library(cltest)

# 16.682 seconds if make_contributions = FALSE
# 42.709 seconds if make_contributions = TRUE
perm_data <- make_permutation_data(
  model_info = model_info,
  max_units = 2.5,
  make_contributions = TRUE,
  correlation_threshold = 0.70
)

# 27.08 seconds
wftest_list <- walk_forward_test(
  make_permutation_data_output = perm_data,
  lookback_year_seq = c(1, 3, 5, 10)
)

report_xts <- make_report_xts(
  walk_forward_test_output = wftest_list,
  benchmark_symbol = 'SPY',
  max_units = 2.5
)

# all reports
chart_rolling_performance(report_xts)
chart_performance_summary(report_xts)
chart_risk_return_scatter(report_xts)
table_annualized_returns(report_xts)
table_calendar_returns(report_xts)
table_drawdowns(report_xts)
# note perm_data is the input and that make_contributions must = TRUE
table_contribution(perm_data)
```
- The purpose of the above analysis is four-fold:
  - The correlation between each model should not exceed that specified by `correlation_threshold`
  - Each lookback length (in years) should have favorable performance metrics
  - The PnL curves should exhibit obvious clustering regardless of lookback length (ie, a robustness check)
  - After the optimal lookback length is selected (see hunk below), `model_info` is adjusted accordingly
```r
wftest_list$'10'$Info
```
- NB: 
  - The ordering of the models in `model_info` indicates prioritization
  - Model units are primarily determined through analysis of individual models, although they make be later adjusted if, for example, the drawdowns of one model are offset by returns of another, in which case addition units could be allocated to the former model
- Once a portfolio framework is decided upon, the portfolio is deployed with the *cldeploy* package and **the process above is repeated at the end of each quarter**

## Custom Model Generation
 
- Obviously, custom models may be manually added to the *clmodels* package
- Each model function:
  - should have the number of units allocated to it be adjustable
  - is responsible for outputting an XTS of asset units (and nothing more)
  - handling both Testing and Deployment scenarios
- For reference, see the source code and observe the output of each function already present in the *clmodels* package
 
## Deployment

### Prices
 
- The *cldeploy* package is intended to be used on a server and run each day pre- or post-market to update (ie, fetch and cache) Yahoo OHLCV data
- Example cronjob:
```
0 5 * * MON-FRI cd && R -e "cldeploy::deploy('price_update')"
```

### Autotrading

- Autotrading is executed by setting the `to_execute` argument to 'cron'
- The function will not run if the market isn't open
- Early closes are handled by the function
- Although the OHLCV data in the `prices` folder ends with the prices of the trading day prior, recent OHLC data is fetched from TD for each asset automatically
- Example cronjobs:
```
58 12 * * MON-FRI cd && R -e "cldeploy::deploy()"
58 15 * * MON-FRI cd && R -e "cldeploy::deploy()"
```
- If the defaults need to be changed, `model_info` from the Testing Phase can be stored in the global `.Rprofile` for convenience:
```
model_info <- c(
  'CAN' = 1.5,
  'GAN' = 1,
  'KDA_no_treasuries' = 1.5)
```
- Then an `.R` file can be created...
```r
cldeploy::deploy(model_info = model_info)
```
- ...along with new cronjobs:
```
58 12 * * MON-FRI cd && Rscript /path/to/Rscript
58 15 * * MON-FRI cd && Rscript /path/to/Rscript
```

### Semi-autotrading
 
- The same functionality as above (trading with *R* instead of using software provided by a broker), however trading is executed at the user's discretion
- In an R session (using the same `.Rprofile` as above):
```r
cldeploy::deploy('force', model_info)
```

### Manual trading

- Makes a report which indicates the number of shares of each asset to buy/sell which can later be manually inputted into the user's trading software
- In an R session (using the same `.Rprofile` as above):
```r
cldeploy::deploy('report', model_info)
```
